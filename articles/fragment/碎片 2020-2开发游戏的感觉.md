---
title: 2020-2五虎棋开发
tags: [HTML, JavaScript, ES6, CSS]
---

## 前言

我们那边称作下方, 学名五虎棋, 在农村盛行, 4 x 4 方格, 25 个空位, 拿着树枝和叶片就可以玩起来的游戏

最近在做这个游戏微信小程序版本, 这个帖子做一下记录

## 游戏规则

简单介绍一下规则, 三个阶段: `下棋阶段, 逼棋阶段, 走棋阶段`

### 下棋阶段

1. 默认每人每轮下一个棋子, 但是当形成三斜, 四斜, 五斜, 一方, 竖向, 横向的时候, 规则会打破

| 规则       | 额外下子个数 |
| ---------- | ------------ |
| 一方       | 1            |
| 三斜       | 1            |
| 四斜       | 2            |
| 五斜(五通) | 3            |
| 横向或竖向 | 2            |



### 逼棋阶段

1. 当棋盘下满的时候, 进入逼棋阶段, 玩家各拿掉对方一个棋子



### 走棋阶段

1. 跟下棋阶段规则相同, 但形成方或者斜的时候, 拿掉对方的棋子(个数见上表)
2. 如果被对方堵死, 再次进入逼棋阶段

当一方棋子小于 3 的时候, 判定为输



## 思路

1. 使用 5 x 5 矩阵模拟整个棋盘, 0 代表空位, 1 代表 甲, 2 代表 乙
2. 每下一个棋, 进入判断阶段

### 判断阶段

**方:** [中心点, 上, 左上, 左], [中心点, 左, 左下, 下], [中心点, 下, 右下, 右], [中心点, 右, 右上, 上], 四个规则, 要求四个元素相等, 每成一个形成一方

**斜:** 根据棋子落点, 斜着向四个方向 `右上, 左下, 左上, 右下` 扩展, 如果相等继续扩展, 当扩展到 undefined, 说明到达了边, 那这个边则打通, 标记为 true, 并且扩展的时候设置 offset, 扩展多少个位置(根据这个计算形成斜的类型)

**横向或竖向:** 这个比较简单, 拿到对应的数组, 去一下重, 如果长度变成了 1, 则说明相等, 否则不能形成

每一次判断保存对应的坐标数组[x, y] `以备后用于高亮元素`

### 下一个棋子是谁

获取到形成方, 斜, 横竖的数量后, 判断上一局下剩下的棋子(默认为 0, 比如形成了五斜, 需要多下三个, 下了一个后形成了方, 则继续多下 2 + 1 = 3 个), 如果这个值不是 0 则不变 玩家, 并且棋子数 -- 

### 判断下棋阶段结束

可以每一次都遍历数组判断是否有 0 `空位`, 但是时间复杂度过高, 可以标记甲乙下棋的个数, 当等于 25 的时候即为下棋阶段结束



目前完成了下棋阶段和逼棋阶段, 还没写 server (需要用到 websocket) 和 走棋阶段, 写完后贴出代码和图片

### 走棋阶段

这个阶段, 增加了数组的状态

目前状态列表为

| 数字 | 代表             |
| ---- | ---------------- |
| 1    | 玩家 a 的棋子    |
| 2    | 玩家 b 的棋子    |
| 3    | a 棋子高亮       |
| 4    | b 棋子高亮       |
| 5    | a 棋子能走的地方 |
| 6    | b 棋子能走的地方 |

设置玩这些状态, 开始检测玩家点击, 当玩家点击棋子的时候, 可以通过 data- 属性传输数据到 e 对象

```html
<view class="chesses-row" wx:for-index="x" wx:for="{{chessesArr}}" wx:key="x">
      <view class="chess-col" wx:for="{{item}}" wx:key="xy" wx:for-index='y'>
        <view class="chess-wrapper"
              bindtap="checkoutChess"
              bindlongpress="removeOne"
              data-chessIndex="{{[x, y]}}"
        >
        </view>
      </view>
    </view>
```

获取到 x, y 坐标后, 可以进行上下左右的判断, 如果有空位, 则高亮, 否则提示当前棋子不能移动

这里要注意一点, 用户可能点击一个棋子后, 再点击一个, 这样怎么办

解决方案是添加一个状态是不是第一次点击, 如果是, 把当前棋盘状态克隆一份`涉及到深拷贝, 但是只是二维数组, 比较简单`, 然后执行高亮

如果是第二次点击, 把当前克隆的数组再赋值回来, 记住当棋子移动完毕后, 克隆数组要更新

每一次走棋, 都需要判断目标位置的成项规则, 规则与前面下棋相同, 就这样一直进行下去, 当一方棋子小于三个(前面统计了棋子数量, 不需要遍历)的时候, 判断对方获胜



## server 的编写

由于在微信小程序不适合使用 socket.io `也可能我才华疏浅`, 只能用原生

目前 server 不能指定玩家, 每进入一个玩家, 就往 sparePlayer 里面添加, 当空闲玩家等于 2 的时候, 设置这两个为对战玩家, 清空 sparePlayer, 然后下棋操作更新数组, 发放到另一个里面, 进行各种判断



加油 !

